<!-- this is an HTML page for a check-in system that uses geolocation 
to get the user's location and send it to the Django backend. -->

{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'css/button.css' %}">
    <link rel="stylesheet" href="{% static 'css/map.css' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-In Page</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        #map {
            width: 600px; 
            height: 300px; 
            border-radius: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>Check-In System</h1>

    {% if message %}
        <p class="success-message">{{ message }}</p>
        {% if task %}
        <script>
            setTimeout(function () {
                window.location.href = "/tasks/";
            }, 7000);
        </script>
        {% endif %}
    {% elif error %}
        <p class="error-message">{{ error }}</p>
    {% endif %}

    <div id="map"></div>

    <script>
        var map = L.map('map'); // Map initialization
    
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
    
        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            map.setView([lat, lon], 15); // Put marker on user location
            L.marker([lat, lon]).addTo(map)
                .bindPopup("You're here!")
                .openPopup();
        }
        
        var marker = L.marker([50.7354611346658, -3.5339872116477524]).addTo(map)
            .bindPopup("Forum reycling point")
            .openPopup();

        var circle = L.circle([50.744283404596366,  -3.54216391886783], 50, {
            color: 'purple',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 500
        }).addTo(map)
            .bindPopup("Duryard PV solar panels")
            .openPopup();

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    showPosition(position);
                    const taskId = "{{ task.id|default:0 }}";
                    if (taskId == 0) {
                        alert("Task ID not found.");
                        return;
                    }
                    window.location.href = `/get_location/${taskId}/?lat=${position.coords.latitude}&lon=${position.coords.longitude}`;
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
    
        // Automatically get and show user's location on page load
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, function (error) {
                alert("Geolocation failed: " + error.message);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    </script>    

    <button onclick="getLocation()">Check-In</button>
</body>
</html>
