{% extends "base.html" %}
{% load static %}

{% block title %}Daily Tasks{% endblock %}

{% block content %}
<!-- Link to tasks.css -->
<link rel="stylesheet" href="{% static 'tasks.css' %}">

<!-- Image Section -->
<div class="top-section relative">
    <div class="image-container bg-green-700 overflow-hidden" style="height: 800px;">
        <img src="{% static 'images/dailyTasks.jpg' %}" alt="Image" class="w-full h-full rounded-lg object-cover" style="object-position: center top;">
    </div>

    <!-- Tasks Section -->
    <div class="tasks-section absolute inset-0 flex flex-col justify-center items-center text-white">
        <div class="text-white text-center mb-6">
            <h1 class="text-6xl font-bold text-center mb-6 px-4 sm:px-0 sm:text-6xl text-4xl">Daily Tasks</h1>
            <h2 class="text-3xl text-center mb-4 px-4 sm:text-3xl text-xl">Tasks that can be completed</h2>
        </div>
        
        <!-- Changed grid to be responsive -->
        <div class="task-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 w-full max-w-6xl px-4">
            {% if tasks %}
                {% for task in tasks %}
                    <div class="task-item p-4 mb-4 bg-gray-800 rounded-lg overflow-hidden">
                        <strong class="task-name text-xl text-white block mb-2 break-words">{{ task.task_name }}</strong>

                        <!-- Progress Bar -->
                        <div class="progress-container mt-2 w-full">
                            <div class="progress-bar bg-green-400 text-center text-white overflow-hidden text-sm" id="progress-bar-{{ task.id }}" style="width: {{ task.progress_percentage }}%;">
                                {{ task.current_progress }}/{{ task.target }}
                            </div>
                        </div>

                        <!-- Task Actions -->
                        <div class="task-actions mt-4 flex flex-col">
                            <!-- Check In Button -->
                            <form action="{% url 'get_location' task.id %}" method="GET" class="w-full">
                                <button type="submit" class="btn btn-primary w-full mb-2">Check In</button>
                            </form>

                            <!-- Claim Task Button -->
                            <button id="claim-button-{{ task.id }}" class="btn btn-success mb-2 w-full" onclick="claimTask({{ task.id }})" {% if task.has_checked_in %} disabled {% endif %}>
                                Claim Task
                            </button>

                            <!-- Progress Update Buttons -->
                            <button class="btn btn-warning w-full" onclick="updateProgress({{ task.id }}, 'decrease')">Decrease Progress</button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center mt-6 bg-gray-800 text-white p-4 rounded-lg shadow-lg mb-6 flex justify-center">
                    <p class="text-white">No tasks available to complete.</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Button to Go to Task Gallery -->
        <div class="text-center mt-6">
            <a href="{% url 'gallery_page' %}" class="bg-blue-700 text-white px-6 py-3 rounded-lg hover:bg-blue-800 shadow-lg">
                View Task Gallery
            </a>
        </div>

        <p class="text-center mt-6 bg-blue-800 text-white p-3 rounded-lg shadow-lg mb-6">
            <a href="{% url 'home' %}" class="text-white">Back to Home</a>
        </p>
    </div>
</div>

<!-- JavaScript Section for AJAX Functionality -->
<script>
    function updateProgress(taskId, action) {
        $.ajax({
            url: "{% url 'update_progress' 1 'increase' %}".replace("1", taskId).replace("increase", action),
            type: "POST",
            data: { csrfmiddlewaretoken: "{{ csrf_token }}" },
            success: function(response) {
                if (response.success) {
                    let progressBar = document.getElementById("progress-bar-" + taskId);
                    progressBar.style.width = response.new_progress + "%";
                    progressBar.innerText = response.current_progress + "/" + response.target;
                } else {
                    alert(response.message);
                }
            }
        });
    }

    function claimTask(taskId) {
        $.ajax({
            url: "{% url 'update_progress' 1 'claim' %}".replace("1", taskId),
            type: "POST",
            data: { csrfmiddlewaretoken: "{{ csrf_token }}" },
            success: function(response) {
                if (response.success) {
                    let progressBar = document.getElementById("progress-bar-" + taskId);
                    progressBar.style.width = "100%";
                    progressBar.innerText = response.current_progress + "/" + response.target;

                    // Disable the claim button after it has been clicked
                    document.getElementById("claim-button-" + taskId).disabled = true;
                } else {
                    alert(response.message);
                }
            }
        });
    }
</script>

{% endblock %}