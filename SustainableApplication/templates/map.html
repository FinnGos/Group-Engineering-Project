{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block content %}
  <div class="text-center my-10">
    <h1 class="text-5xl font-bold">Your Exeter Campus</h1>
  </div>

  <div class="text-center mb-6">
    <a href="{% url 'shop' %}">
      <button class="px-6 py-3 bg-green-700 text-white rounded-lg hover:bg-green-600 transition">Go to Shop</button>
    </a>
  </div>

  <!-- User's Score Display -->
  <div class="flex justify-center my-4">
    <div class="bg-green-200 p-4 rounded-lg shadow-md flex gap-6">
      <p class="text-lg font-semibold">ðŸ’° Carbo Coins: <span class="font-bold">{{ current_points }}</span></p>
      <p class="text-lg font-semibold">ðŸŒ± Campus Cred: <span class="font-bold">{{ all_time_points }}</span></p>
    </div>
  </div>


  <div class="flex justify-center my-8">
    <div class="map-container">
      {% for building in buildings %}
        {% if user_buildings|get_item:building.id %}
          <img src="{{ building.image.url }}" class="building" style="top: {{ building.y }}px; left: {{ building.x }}px;">
        {% else %}
          <img src="{{ building.locked_image.url }}" class="building" style="top: {{ building.y }}px; left: {{ building.x }}px;">
        {% endif %}
      {% endfor %}

      {% for user_item in user_items %}
        <div class="item" style="left: {{ user_item.x }}px; top: {{ user_item.y }}px; width: {{ user_item.size }}px; height: {{ user_item.size }}px;">
          <img src="{{ user_item.item.image.url }}" alt="{{ user_item.item.name }}">
        </div>
      {% endfor %}

      {% for trash in rubbish %}
        <img src="{{ trash.image.url }}" alt="Rubbish" style="position: absolute; left: {{ trash.x }}px; top: {{ trash.y }}px; width: 20px; height: 20px;" />
        <form action="{% url 'clean_rubbish' trash.id %}" method="post" style="position: absolute; left: {{ trash.x }}px; top: {{ trash.y|add:25 }}px;">
          {% csrf_token %}
          <button type="submit">Clean</button>
        </form>
      {% endfor %}
    </div>
  </div>

  <div id="message-box" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-6 rounded-md shadow-md bg-white hidden">
    <p id="message-text" class="text-xl"></p>
    <button id="close-message" class="mt-4 px-4 py-2 bg-green-700 text-white rounded-md hover:bg-green-600 focus:outline-none">Close</button>
  </div>
{% endblock %}

{% block extra_css %}
  <style>
    .map-container {
      position: relative;
      width: 1800px;
      height: 800px;
      background: url('{% static "images/grass_background.png" %}') no-repeat center;
      background-size: cover;
      border: 2px solid black;
      overflow: hidden;
    }

    .building {
      position: absolute;
      width: 150px;
      height: 150px;
    }

    .item {
      position: absolute;
    }
  </style>
{% endblock %}

<!-- JavaScript for pop up box that displays error or success messages -->
{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const messageBox = document.getElementById("message-box");
    const messageText = document.getElementById("message-text");
    const closeButton = document.getElementById("close-message");

    {% if messages %}
      setTimeout(() => {
        {% for message in messages %}
          messageText.textContent = "{{ message|escapejs }}";
          messageBox.classList.remove("hidden");
        {% endfor %}
      }, 100);
    {% endif %}

    closeButton.addEventListener("click", function () {
      messageBox.classList.add("hidden");
    });
  });
</script>
{% endblock %}
