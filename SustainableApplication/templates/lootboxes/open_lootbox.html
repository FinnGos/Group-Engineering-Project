{% extends "base.html" %}
{% load static %}

{% block title %}Open Lootbox{% endblock %}

{% block content %}
<!-- Link to open_lootbox.css -->
<link rel="stylesheet" href="{% static 'css/open_lootbox.css' %}">

<!-- Image Section -->
<div class="top-section relative">
  <div class="image-container bg-green-700 overflow-hidden" style="height: 800px;">
    <img src="{% static 'images/lootboxes.jpg' %}" alt="Image" class="w-full h-full rounded-lg object-cover" style="object-position: center;">
  </div>

  <!-- Lootbox Section -->
  <div class="mt-8 absolute inset-0 flex flex-col justify-top items-center text-white">
    <div class="font-bold outlined-text text-white text-center p-6 mb-6">
      <h1 class="text-6xl mb-1">Lootboxes</h1>
      <p class="text-3xl" id="user-points">Current Points: {{ request.user.current_points }}</p>
    </div>

  <!-- Lootbox Icon -->  
  <div class="mb-6">
    <img src="{% static 'images/lootbox.png' %}" alt="Lootbox" class="w-48 h-auto transition-transform duration-300 transform hover:scale-110">
  </div>

  <!-- Lootbox Button -->
  <form id="lootboxForm" method="POST">
    {% csrf_token %}
    <button type="submit" id="openLootboxButton" class="current-points text-white text-center p-6 mt-6 bg-green-700 rounded-lg transition-transform duration-300 transform hover:scale-110">
      Open Lootbox - 100 Points
    </button>
  </form>

  <!-- Display Lootbox Result -->
  <div id="loot-result"></div>

  <p class="text-center mt-6 bg-blue-800 text-white p-3 rounded-lg shadow-lg mb-6 transition-transform duration-300 transform hover:scale-110">
    <a href="{% url 'home' %}" class="text-white">Back to Home</a>
  </p>

  <script>
    $(document).ready(function () {
      $("#lootboxForm").submit(function (event) {
        event.preventDefault(); // Prevent normal form submission

        $.ajax({
          url: '{% url "open_lootbox" %}',
          type: "POST",
          data: {
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: function (response) {
            const lootResult = $("#loot-result");

            if (response.success) {
              // Update user points
              $("#user-points").text(`Points: ${response.new_points}`);

              if (response.loot_item) {
                let duplicateMessage = response.is_duplicate
                  ? "<p>(You already own this item, so points were refunded)</p>"
                  : "";

                lootResult.html(`
                          <h3>Congratulations!</h3>
                          <p>You received: ${response.loot_item.name}</p>
                          <img src="${response.loot_item.image}" alt="${response.loot_item.name}" width="200" />
                          <p>Fun Fact: ${response.loot_item.fact}</p>
                          ${duplicateMessage}
                      `);
              } else {
                lootResult.html("<p>You got nothing this time.</p>");
              }
            } else {
              lootResult.html(
                `<p style="color:red;">${
                  response.error || "Something went wrong!"
                }</p>`
              );
            }
          },
          error: function (xhr) {
            const errorMessage =
              xhr.responseJSON?.error || "Error: Unable to open lootbox.";
            alert(errorMessage);
          },
        });
      });
    });
  </script>
</div>
{% endblock %}